<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Thu Há»“i TÃ i Sáº£n</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { user-select: none; }

#scanner-wrapper {
  position: relative;
  width: 100%;
  height: 55vh;
  background: black;
  overflow: hidden;
  border-radius: 12px;
}

#scanner video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
}

.scan-area {
  width: 80%;
  max-width: 320px;
  height: 160px;
  border: 2px solid #00ffcc;
  box-shadow: 0 0 0 9999px rgba(0,0,0,.45);
  border-radius: 12px;
  position: relative;
}

.scan-line {
  position: absolute;
  height: 2px;
  width: 100%;
  background: red;
  animation: scan 2s linear infinite;
}

@keyframes scan {
  from { top: 0; }
  to { top: calc(100% - 2px); }
}
</style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App() {
  const [barcode, setBarcode] = useState("");
  const [status, setStatus] = useState("");
  const [webhookUrl, setWebhookUrl] = useState(localStorage.getItem("webhookUrl") || "");
  const scannerRef = useRef(null);

  useEffect(() => {
    let stream;
    let rafId;

    const stopAll = () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (window.Quagga) try { Quagga.stop(); } catch {}
    };

    const start = async () => {
      try {
        if ("BarcodeDetector" in window) {
          const detector = new window.BarcodeDetector({ formats: ["qr_code","code_128","ean_13"] });
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });

          const video = document.createElement("video");
          video.setAttribute("playsinline", true);
          video.srcObject = stream;
          await video.play();
          scannerRef.current.appendChild(video);

          const scan = async () => {
            const codes = await detector.detect(video);
            if (codes.length) {
              setBarcode(codes[0].rawValue);
              stopAll();
              return;
            }
            rafId = requestAnimationFrame(scan);
          };
          scan();
        } else {
          Quagga.init({
            inputStream: { type: "LiveStream", target: scannerRef.current },
            decoder: { readers: ["qr_reader","code_128_reader","ean_reader"] }
          }, err => { if (!err) Quagga.start(); });

          Quagga.onDetected(res => {
            setBarcode(res.codeResult.code);
            stopAll();
          });
        }
      } catch (e) {
        console.error("Camera error:", e);
      }
    };

    start();
    return stopAll;
  }, []);

  return (
    <div className="max-w-md mx-auto p-4 space-y-3">
      <h1 className="text-xl font-bold text-center">ðŸ“¦ Thu Há»“i TÃ i Sáº£n</h1>

      <input
        className="w-full p-2 border rounded"
        placeholder="Webhook URL n8n"
        value={webhookUrl}
        onChange={e => {
          setWebhookUrl(e.target.value);
          localStorage.setItem("webhookUrl", e.target.value);
        }}
      />

      <input
        className="w-full p-2 border rounded"
        placeholder="QR / Barcode"
        value={barcode}
        onChange={e => setBarcode(e.target.value)}
      />

      <div id="scanner-wrapper">
        <div ref={scannerRef} id="scanner"></div>
        <div className="overlay">
          <div className="scan-area">
            <div className="scan-line"></div>
          </div>
        </div>
      </div>

      {status && <p>{status}</p>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
