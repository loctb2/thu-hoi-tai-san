<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thu H·ªìi T√†i S·∫£n</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { user-select: none; }

    #scanner-wrapper {
      position: relative;
      width: 100%;
      height: 55vh;
      background: black;
      overflow: hidden;
      border-radius: 12px;
    }

    #scanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .scan-area {
      position: relative;
      width: 80%;
      max-width: 320px;
      height: 160px;
      border: 2px solid #00ffcc;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.45);
      border-radius: 12px;
    }

    .scan-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      background: red;
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      from { top: 0; }
      to { top: calc(100% - 2px); }
    }
  </style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Quagga (barcode fallback) -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App() {
  const [barcode, setBarcode] = useState("");
  const [photo, setPhoto] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(null);
  const [webhookUrl, setWebhookUrl] = useState(
    localStorage.getItem("webhookUrl") || ""
  );
  const [status, setStatus] = useState("");
  const [cameraOn, setCameraOn] = useState(false);

  const fileInputRef = useRef(null);
  const supportsBarcodeDetector = "BarcodeDetector" in window;

  /* ===== CAMERA + SCAN ===== */
  useEffect(() => {
    if (!cameraOn) return;

    let stream = null;
    let detector = null;
    let timerId = null;
    const scannerEl = document.getElementById("scanner");

    const stopAll = () => {
      if (timerId) clearTimeout(timerId);
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (window.Quagga) {
        try {
          Quagga.offDetected();
          Quagga.stop();
        } catch {}
      }
      if (scannerEl) scannerEl.innerHTML = "";
    };

    const startNative = async () => {
      detector = new BarcodeDetector({
        formats: ["qr_code", "code_128", "ean_13", "ean_8"]
      });

      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      });

      const video = document.createElement("video");
      video.setAttribute("playsinline", true);
      video.srcObject = stream;
      await video.play();
      scannerEl.appendChild(video);

      const scan = async () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const codes = await detector.detect(video);
          if (codes.length > 0) {
            setBarcode(codes[0].rawValue);
            setCameraOn(false);
            stopAll();
            return;
          }
        }
        timerId = setTimeout(scan, 120);
      };

      scan();
    };

    const startQuagga = () => {
      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: scannerEl,
          constraints: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        locator: { halfSample: false },
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader"
          ]
        }
      }, err => {
        if (!err) Quagga.start();
      });

      Quagga.onDetected(res => {
        setBarcode(res.codeResult.code);
        setCameraOn(false);
        stopAll();
      });
    };

    (async () => {
      try {
        if (supportsBarcodeDetector) {
          await startNative();
        } else {
          startQuagga();
        }
      } catch (err) {
        console.error("Camera error:", err);
        alert("Kh√¥ng th·ªÉ m·ªü camera. H√£y ki·ªÉm tra quy·ªÅn camera v√† HTTPS.");
        setCameraOn(false);
      }
    })();

    return stopAll;
  }, [cameraOn]);

  /* ===== PHOTO ===== */
  const handlePhoto = e => {
    const file = e.target.files[0];
    if (!file) return;
    setPhoto(file);
    const r = new FileReader();
    r.onload = () => setPhotoPreview(r.result);
    r.readAsDataURL(file);
  };

  /* ===== SEND N8N ===== */
  const sendToN8n = async () => {
    if (!barcode && !photo) {
      alert("C·∫ßn QR/Barcode ho·∫∑c ·∫¢nh");
      return;
    }

    let photoBase64 = null;
    if (photo) {
      photoBase64 = await new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(photo);
      });
    }

    const payload = {
      barcode: barcode || null,
      photo: photoBase64,
      timestamp: new Date().toISOString(),
      device: navigator.userAgent
    };

    const r = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    setStatus(r.ok ? "success" : "error");
    setTimeout(() => setStatus(""), 3000);
  };

  return (
    <div className="max-w-md mx-auto p-4 space-y-4">
      <h1 className="text-xl font-bold text-center">üì¶ Thu H·ªìi T√†i S·∫£n</h1>

      <input
        className="w-full p-2 border rounded"
        placeholder="Webhook URL n8n"
        value={webhookUrl}
        onChange={e => {
          setWebhookUrl(e.target.value);
          localStorage.setItem("webhookUrl", e.target.value);
        }}
      />

      <input
        className="w-full p-2 border rounded"
        placeholder="QR / Barcode"
        value={barcode}
        onChange={e => setBarcode(e.target.value)}
      />

      {/* N√öT B·∫¨T / T·∫ÆT CAMERA */}
      <button
        onClick={() => setCameraOn(v => !v)}
        className={`w-full p-3 rounded font-semibold text-white ${
          cameraOn ? "bg-red-600" : "bg-green-600"
        }`}
      >
        {cameraOn ? "‚è∏ T·∫Øt camera qu√©t" : "‚ñ∂ B·∫≠t camera qu√©t QR / Barcode"}
      </button>

      <div id="scanner-wrapper">
        <div id="scanner"></div>
        <div className="overlay">
          <div className="scan-area">
            <div className="scan-line"></div>
          </div>
        </div>
      </div>

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        capture="environment"
        className="hidden"
        onChange={handlePhoto}
      />

      <button
        onClick={() => fileInputRef.current.click()}
        className="w-full bg-gray-200 p-2 rounded"
      >
        üì∑ Ch·ª•p ·∫£nh v·∫≠t t∆∞
      </button>

      {photoPreview && (
        <img src={photoPreview} className="rounded border" />
      )}

      <button
        onClick={sendToN8n}
        className="w-full bg-indigo-600 text-white p-3 rounded font-bold"
      >
        üöÄ G·ª≠i l√™n n8n
      </button>

      {status === "success" && (
        <p className="text-green-600">‚úî G·ª≠i th√†nh c√¥ng</p>
      )}
      {status === "error" && (
        <p className="text-red-600">‚úñ G·ª≠i l·ªói</p>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>