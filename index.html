<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Thu H·ªìi T√†i S·∫£n</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { user-select:none; }
#scanner-wrapper {
  position:relative;
  width:100%;
  height:55vh;
  background:black;
  border-radius:12px;
  overflow:hidden;
}
#scanner video {
  width:100%;
  height:100%;
  object-fit:cover;
  filter: brightness(1.2) contrast(1.2) saturate(1.1);
}
.overlay {
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.4);
  display:flex;
  justify-content:center;
  align-items:center;
  pointer-events:none;
}
.scan-area {
  width:80%;
  max-width:320px;
  height:160px;
  border:2px solid #00ffcc;
  box-shadow:0 0 0 9999px rgba(0,0,0,.45);
  border-radius:12px;
  position:relative;
}
.scan-line {
  position:absolute;
  left:0;
  width:100%;
  height:2px;
  background:red;
  animation:scan 2s linear infinite;
}
@keyframes scan {
  from{top:0}
  to{top:calc(100% - 2px)}
}
</style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script type="text/babel">
const {useState,useEffect,useRef} = React;

function App(){
  const [barcode,setBarcode] = useState("");
  const [scannedList,setScannedList] = useState([]);
  const [cameraOn,setCameraOn] = useState(false);
  const [photo,setPhoto] = useState(null);
  const [photoPreview,setPhotoPreview] = useState(null);
  const [status,setStatus] = useState("");
  const [webhookUrl,setWebhookUrl] = useState(localStorage.getItem("webhookUrl")||"");

  const fileInputRef = useRef(null);
  const lastScanRef = useRef({value:null,time:0});
  const supportsBarcodeDetector = "BarcodeDetector" in window;

  const canAcceptCode = value => {
    const now = Date.now();
    if(lastScanRef.current.value===value && now-lastScanRef.current.time<2000) return false;
    lastScanRef.current={value,time:now};
    return true;
  };

  useEffect(()=>{
    if(!cameraOn) return;

    let stream, detector, rafId;
    const scannerEl = document.getElementById("scanner");

    const stopAll = ()=>{
      if(rafId) cancelAnimationFrame(rafId);
      if(stream) stream.getTracks().forEach(t=>t.stop());
      try{Quagga.stop()}catch{}
      if(scannerEl) scannerEl.innerHTML="";
    };

    const startNative = async ()=>{
      detector = new BarcodeDetector({formats:["qr_code","code_128","ean_13","ean_8"]});

      stream = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ideal:"environment"},
          width:{ideal:1920},
          height:{ideal:1080},
          frameRate:{ideal:30,max:60}
        }
      });

      const video = document.createElement("video");
      video.playsInline=true;
      video.srcObject=stream;
      await video.play();
      scannerEl.appendChild(video);

      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      if(caps){
        const adv={};
        if(caps.focusMode?.includes("continuous")) adv.focusMode="continuous";
        if(caps.exposureMode?.includes("continuous")) adv.exposureMode="continuous";
        try{ await track.applyConstraints({advanced:[adv]}); }catch{}
      }

      const scan = async ()=>{
        if(video.readyState===4){
          const codes = await detector.detect(video);
          if(codes.length){
            const val=codes[0].rawValue;
            if(canAcceptCode(val)){
              setBarcode(val);
              setScannedList(l=>[...l,val]);
            }
          }
        }
        rafId=setTimeout(scan,120);
      };
      scan();
    };

    const startQuagga = ()=>{
      Quagga.init({
        inputStream:{type:"LiveStream",target:scannerEl,constraints:{facingMode:"environment"}},
        decoder:{readers:["code_128_reader","ean_reader","ean_8_reader"]}
      },err=>{ if(!err) Quagga.start(); });

      Quagga.onDetected(res=>{
        const val=res.codeResult.code;
        if(canAcceptCode(val)){
          setBarcode(val);
          setScannedList(l=>[...l,val]);
        }
      });
    };

    try{
      supportsBarcodeDetector ? startNative() : startQuagga();
    }catch(e){
      alert("Kh√¥ng th·ªÉ m·ªü camera");
    }

    return stopAll;
  },[cameraOn]);

  const handlePhoto=e=>{
    const f=e.target.files[0];
    if(!f) return;
    setPhoto(f);
    const r=new FileReader();
    r.onload=()=>setPhotoPreview(r.result);
    r.readAsDataURL(f);
  };

  const sendToN8n=async()=>{
    if(!scannedList.length && !photo){ alert("Ch∆∞a c√≥ d·ªØ li·ªáu"); return; }

    let photoBase64=null;
    if(photo){
      photoBase64=await new Promise(r=>{
        const fr=new FileReader();
        fr.onload=()=>r(fr.result);
        fr.readAsDataURL(photo);
      });
    }

    await fetch(webhookUrl,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        barcodes:scannedList,
        photo:photoBase64,
        timestamp:new Date().toISOString(),
        device:navigator.userAgent
      })
    });

    setStatus("success");
    setTimeout(()=>setStatus(""),3000);
  };

  return (
  <div className="max-w-md mx-auto p-4 space-y-3">
    <h1 className="text-xl font-bold text-center">üì¶ Thu H·ªìi T√†i S·∫£n</h1>

    <input className="w-full p-2 border rounded"
      placeholder="Webhook URL n8n"
      value={webhookUrl}
      onChange={e=>{setWebhookUrl(e.target.value);localStorage.setItem("webhookUrl",e.target.value);}}
    />

    <button
      onClick={()=>setCameraOn(v=>!v)}
      className={`w-full p-3 rounded text-white font-bold ${cameraOn?"bg-red-600":"bg-green-600"}`}>
      {cameraOn?"‚è∏ T·∫Øt camera":"‚ñ∂ B·∫≠t camera qu√©t"}
    </button>

    <div id="scanner-wrapper">
      <div id="scanner"></div>
      <div className="overlay">
        <div className="scan-area"><div className="scan-line"></div></div>
      </div>
    </div>

    {scannedList.length>0 &&
      <div className="bg-white p-2 rounded text-sm max-h-40 overflow-auto">
        <b>üìã ƒê√£ qu√©t:</b>
        {scannedList.map((c,i)=><div key={i}>{c}</div>)}
      </div>
    }

    <input ref={fileInputRef} type="file" accept="image/*" capture="environment" className="hidden" onChange={handlePhoto}/>
    <button onClick={()=>fileInputRef.current.click()} className="w-full bg-gray-200 p-2 rounded">üì∑ Ch·ª•p ·∫£nh</button>

    {photoPreview && <img src={photoPreview} className="rounded border" />}

    <button onClick={sendToN8n} className="w-full bg-indigo-600 text-white p-3 rounded font-bold">
      üöÄ G·ª≠i l√™n n8n
    </button>

    {status==="success" && <p className="text-green-600 text-center">‚úî G·ª≠i th√†nh c√¥ng</p>}
  </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>