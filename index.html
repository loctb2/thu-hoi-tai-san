<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thu Há»“i TÃ i Sáº£n</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Disable select -->
  <style>
    body {
      -webkit-user-select: none;
      user-select: none;
    }

    /* ===== SCANNER STYLE ===== */
    #scanner-wrapper {
      position: relative;
      width: 100%;
      height: 60vh;
      background: black;
      overflow: hidden;
      border-radius: 12px;
    }

    #scanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .scan-area {
      position: relative;
      width: 80%;
      max-width: 320px;
      height: 160px;
      border: 2px solid #00ffcc;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.45);
      border-radius: 12px;
    }

    .scan-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      background: red;
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      from { top: 0; }
      to { top: calc(100% - 2px); }
    }
  </style>
</head>

<body class="bg-gray-100">

<div id="root"></div>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- QuaggaJS -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App() {
  const [barcode, setBarcode] = useState("");
  const [photo, setPhoto] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(null);
  const [webhookUrl, setWebhookUrl] = useState(
    localStorage.getItem("webhookUrl") || ""
  );
  const [status, setStatus] = useState("");
  const fileInputRef = useRef(null);

  /* ===== INIT CAMERA ===== */
  useEffect(() => {
    if (!window.Quagga) return;

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#scanner"),
        constraints: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      locator: {
        halfSample: false
      }
      decoder: {
        readers: [
          "qr_reader",
          "code_128_reader",
          "ean_reader",
          "ean_8_reader"
        ]
      }
    }, err => {
      if (err) {
        console.error(err);
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(res => {
      const code = res.codeResult.code;
      const type = res.codeResult.format; // qr_code / code_128 / ean...

      console.log("Detected:", type, code);
      
      setBarcode(code);
      Quagga.stop();
    });

    return () => {
      try { Quagga.stop(); } catch(e){}
    };
  }, []);

  /* ===== PHOTO ===== */
  const handlePhoto = e => {
    const file = e.target.files[0];
    if (!file) return;
    setPhoto(file);

    const reader = new FileReader();
    reader.onload = () => setPhotoPreview(reader.result);
    reader.readAsDataURL(file);
  };

  /* ===== SEND TO N8N ===== */
  const sendToN8n = async () => {
    if (!barcode && !photo) {
      alert("Cáº§n Ã­t nháº¥t BARCODE hoáº·c áº¢NH");
      return;
    }

    let photoBase64 = null;
    if (photo) {
      photoBase64 = await new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(photo);
      });
    }

    const payload = {
      barcode: barcode || null,
      photo: photoBase64,
      timestamp: new Date().toISOString(),
      device: navigator.userAgent
    };

    const r = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    setStatus(r.ok ? "success" : "error");
    setTimeout(() => setStatus(""), 3000);
  };

  return (
    <div className="max-w-md mx-auto p-4 space-y-4">

      <h1 className="text-xl font-bold text-center">ðŸ“¦ Thu Há»“i TÃ i Sáº£n</h1>

      {/* Webhook */}
      <input
        className="w-full p-2 border rounded"
        placeholder="Webhook URL n8n"
        value={webhookUrl}
        onChange={e => {
          setWebhookUrl(e.target.value);
          localStorage.setItem("webhookUrl", e.target.value);
        }}
      />

      {/* Barcode */}
      <input
        className="w-full p-2 border rounded"
        placeholder="Barcode (tá»± Ä‘iá»n khi quÃ©t)"
        value={barcode}
        onChange={e => setBarcode(e.target.value)}
      />

      {/* Scanner */}
      <div id="scanner-wrapper">
        <div id="scanner"></div>
        <div className="overlay">
          <div className="scan-area">
            <div className="scan-line"></div>
          </div>
        </div>
      </div>

      {/* Photo */}
      <input
        type="file"
        accept="image/*"
        capture="environment"
        ref={fileInputRef}
        className="hidden"
        onChange={handlePhoto}
      />

      <button
        onClick={() => fileInputRef.current.click()}
        className="w-full bg-gray-200 p-2 rounded"
      >
        ðŸ“· Chá»¥p áº£nh váº­t tÆ°
      </button>

      {photoPreview && (
        <img src={photoPreview} className="rounded border" />
      )}

      {/* Submit */}
      <button
        onClick={sendToN8n}
        className="w-full bg-indigo-600 text-white p-3 rounded font-bold"
      >
        ðŸš€ Gá»­i lÃªn n8n
      </button>

      {status === "success" && <p className="text-green-600">âœ” Gá»­i thÃ nh cÃ´ng</p>}
      {status === "error" && <p className="text-red-600">âœ– Gá»­i lá»—i</p>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>

